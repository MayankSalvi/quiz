<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UGC NET Education - Quiz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="data.js"></script>
    <style>
       

        body {
            padding: 20px;
            background: #f8f9fa
        }

        .option-label {
            display: block;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px
        }

        .option-label:hover {
            background: #f1f1f1
        }

        .flagged {
            background: #fff3cd
        }

        .skipped-badge {
            font-size: 0.75rem
        }

        .timer {
            font-family: monospace
        }

        .explain {
            font-size: 0.95rem
        }

        .subject-tile {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease-in-out;
        }

        .subject-tile:hover {
            background-color: #f0f0f0;
            border-color: #999;
        }

        .subject-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .question-count {
            font-size: 0.9rem;
            color: #666;
        }

        .new-tag {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #28a745;
            color: white;
            padding: 5px 10px;
            border-bottom-left-radius: 8px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .correct {
            color: green
        }

        .wrong {
            color: red
        }
    </style>
</head>

<body>
    <div class="container-fluid">

        <!-- fine  -->
        <div class="row mb-2">
            <div class="col-md-12">
                <h3 id="quizTitle" class="mb-3">Practice quiz</h3>

                <!-- Timer + Buttons Row -->
                <div id="quizHeaderContainer" class="d-none justify-content-between align-items-center flex-wrap py-1">

                    <!-- Left: Timer -->
                    <div class="d-flex align-items-center">
                        <span class="me-1">Time left:</span>
                        <span id="timer" class="timer fs-5 fw-semibold">--:--</span>
                    </div>

                    <!-- Right: Buttons -->
                    <div class="d-flex align-items-center">
                        <button id="retakeFromScore" type="button" class="btn btn-outline-primary me-2 btn-sm"
                            style="display:none;">
                            Retake (shuffle)
                        </button>
                        <button id="refreshBtn" class="btn btn-info btn-sm">Refresh</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mb-3" id="subjectSelectionArea">
            <div class="col-md-12 text-center">
                <!-- Subject tiles will be injected here -->
            </div>
        </div>

        <div class="row mb-3" id="testButtons" style="display: none;">
            <div class="col-md-12 text-center">
                <button id="quickTestBtn" type="button" class="btn btn-primary me-2 btn-sm">Quick Test</button>
                <button id="customTestBtn" type="button" class="btn btn-info btn-sm">Custom Test</button>
            </div>
        </div>

    </div>



    <div class="row mb-3" id="subjectSelectionArea">
        <div class="col-md-12 text-center">
            <!-- Subject tiles will be injected here -->
        </div>
    </div>

    <div class="row mb-3" id="testButtons" style="display: none;">
        <div class="col-md-12 text-center">
            <button id="quickTestBtn" type="button" class="btn btn-primary me-2">Quick Test</button>
            <button id="customTestBtn" type="button" class="btn btn-info">Custom Test</button>
        </div>
    </div>

    <div id="quizContainer" class="container mt-3" style="display: none;">
        <h2 id="quizTitles" class="text-center mb-4"></h2>
    </div>

    <div class="card">
        <div class="card-body">
            <div id="questionArea">
                <!-- question content injected here -->
            </div>

            <div class="d-flex justify-content-between mt-3">
                <div id="navigationButtons">
                    <button id="prevBtn" class="btn btn-secondary mb-2 btn-sm">Prev</button>
                    <button id="nextBtn" class="btn btn-secondary mb-2 btn-sm">Next</button>
                </div>
                <div>
                    <button id="skipBtn" class="btn btn-outline-warning mb-2 btn-sm">Skip</button>
                    <button id="flagBtn" class="btn btn-outline-info mb-2 btn-sm">Flag</button>
                    <button id="reviewBtn" class="btn btn-success mb-2 btn-sm">Submit Quiz</button>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3" id="statusBar" style="display:none;">
        <span id="qIndex"></span>
        <span class="ms-3">Answered: <span id="answeredCount">0</span></span>
        <span class="ms-3">Flagged: <span id="flaggedCount">0</span></span>
        <span class="ms-3">Skipped: <span id="skippedCount">0</span></span>
    </div>

    <!-- Retake Confirmation Modal -->
    <div class="modal fade" id="retakeConfirmModal" tabindex="-1" aria-labelledby="retakeConfirmModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="retakeConfirmModalLabel">Confirm Retake</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to retake the quiz and shuffle questions? Your current progress will be lost.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmRetakeBtn">Retake</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Confirmation Modal -->
    <div class="modal fade" id="refreshConfirmModal" tabindex="-1" aria-labelledby="refreshConfirmModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="refreshConfirmModalLabel">Confirm Refresh</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to refresh the page? Your current progress will be lost.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmRefreshBtn">Refresh</button>
                </div>
            </div>
        </div>
    </div>



    <!-- Review Modal -->
    <div class="modal fade p-4" id="reviewModal" tabindex="-1">
        <div class="modal-dialog modal-xl "></div>
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Review before final submit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="small text-muted px-3 mt-2">You can click an item to jump to the question and change your
                answer.
            </div>
            <hr>
            <div class="modal-body">
                <div id="reviewLists">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Unanswered / Skipped</h6>
                            <ul id="skippedList" class="list-group"></ul>
                            <h6 class="mt-3">Flagged</h6>
                            <ul id="flaggedList" class="list-group"></ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Unanswered <span class="text-danger">*</span></h6>
                            <ul id="unansweredList" class="list-group"></ul>
                        </div>

                    </div>

                    <div class="row">
                        <div class="col-md-12" id="answeredQuestionsSection" style="display: none;">
                            <h6>Answered Questions</h6>
                            <ul id="answeredList" class="list-group"></ul>
                        </div>
                    </div>
                </div>
                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" value="" id="declarationCheckbox">
                    <label class="form-check-label" for="declarationCheckbox">
                        मैं घोषणा करता हूँ कि मैंने सभी प्रश्नों की समीक्षा कर ली है और मैं अंतिम सबमिशन के लिए तैयार
                        हूँ।
                    </label>
                </div>


            </div>
            <div class="modal-footer">
                <button id="cancelSubmit" type="button" class="btn btn-secondary"
                    data-bs-dismiss="modal">Cancel</button>
                <button id="confirmSubmit" type="button" class="btn btn-primary">Submit Final Answers</button>
            </div>
            <div id="submissionWarning" style="display: none;">
                <div class="alert alert-danger m-2" role="alert">
                    कृपया अंतिम सबमिट करने से पहले सभी गैर-छोड़े गए प्रश्नों का उत्तर दें और घोषणा चेकबॉक्स पर टिक करें।
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Score Modal -->
    <div class="modal fade" id="scoreModal" tabindex="-1">
        <div class="modal-dialog modal-sm-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Scorecard</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="scoreSummary"></div>
                    <hr>
                    <div id="detailedReport"></div>
                </div>
                <div class="modal-footer">
                    <button id="closeScore" type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Close</button>
                    <button id="retakeFromScoreModal" type="button" class="btn btn-outline-primary"
                        style="display:none;">Retake (shuffle)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Settings Modal -->
    <div class="modal fade" id="customSettingsModal" tabindex="-1" aria-labelledby="customSettingsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customSettingsModalLabel">Custom Test Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customSettingsForm">
                        <div class="mb-3 form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableTimer" checked>
                            <label class="form-check-label" for="enableTimer">Enable Timer</label>
                        </div>
                        <div class="mb-3" id="timerSettings">
                            <label for="timerDuration" class="">Timer Duration (minutes):</label>
                            <div class="form-text mb-2">Set the total duration for the quiz.</div>
                            <div class="input-group mb-3">
                                <button class="btn btn-outline-secondary" type="button"
                                    id="decreaseTimerDuration">-</button>
                                <input type="number" class="form-control" id="timerDuration" value="10" min="1"
                                    readonly>
                                <button class="btn btn-outline-secondary" type="button"
                                    id="increaseTimerDuration">+</button>
                            </div>

                            <div class="mt-2">
                                <label class="form-label">Timer Type:</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="timerType" id="timerTypeWhole"
                                        value="whole" checked>
                                    <label class="form-check-label" for="timerTypeWhole">Whole Test</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="timerType"
                                        id="timerTypePerQuestion" value="perQuestion">
                                    <label class="form-check-label" for="timerTypePerQuestion">Per Question</label>
                                </div>
                            </div>
                        </div>
                        <script>
                            document.addEventListener('DOMContentLoaded', function () {
                                const timerDurationLabel = document.querySelector('label[for="timerDuration"]');
                                const timerDurationInput = document.getElementById('timerDuration');
                                const timerTypeText = document.querySelector('.form-text');
                                const timerTypeWhole = document.getElementById('timerTypeWhole');
                                const timerTypePerQuestion = document.getElementById('timerTypePerQuestion');

                                function updateTimerSettings() {
                                    if (timerTypePerQuestion.checked) {
                                        timerDurationLabel.textContent = 'Timer Duration (seconds):';
                                        timerTypeText.textContent = 'Set the duration per question in seconds.';
                                        timerDurationInput.value = '30'; // Default to 60 seconds for per question
                                    } else {
                                        timerDurationLabel.textContent = 'Timer Duration (minutes):';
                                        timerTypeText.textContent = 'Set the total duration for the quiz in minutes.';
                                        timerDurationInput.value = '10'; // Default to 10 minutes for whole test
                                    }
                                }

                                timerTypeWhole.addEventListener('change', updateTimerSettings);
                                timerTypePerQuestion.addEventListener('change', updateTimerSettings);

                                // Initial call to set the correct state based on default selection
                                updateTimerSettings();
                            });
                        </script>
                        <div class="mb-3">
                            <label for="numQuestions" class="form-label">Number of Questions:</label>
                            <div class="input-group mb-3">
                                <button class="btn btn-outline-secondary" type="button"
                                    id="decreaseNumQuestions">-</button>
                                <input type="number" class="form-control" id="numQuestions" readonly>
                                <button class="btn btn-outline-secondary" type="button"
                                    id="increaseNumQuestions">+</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enableSkip" checked>
                                <label class="form-check-label" for="enableSkip">Allow Skipping Questions</label>
                            </div>
                        </div>
                        <div class="mb-3" id="skipSettings">
                            <label for="skipCount" class="form-label">Number of Skips allowed:</label>
                            <div class="input-group mb-3">
                                <button class="btn btn-outline-secondary" type="button"
                                    id="decreaseSkipCount">-</button>
                                <input type="number" class="form-control" id="skipCount" value="1" min="1" max="10"
                                    readonly>
                                <button class="btn btn-outline-secondary" type="button"
                                    id="increaseSkipCount">+</button>
                            </div>
                            <!-- <div class="form-text">Set 0 for unlimited skips.</div> -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="startCustomTestBtn">Start Custom Test</button>
                </div>
            </div>
        </div>
    </div>

    </div>

    <!-- IMPORTANT: load Bootstrap JS first so `bootstrap` is available to our script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Application script: wrapped in DOMContentLoaded for safety -->

    <script>

        // const quizDataOriginal = {
        //     "History": [
        //         { "id": 1, "question": "Who was the first Prime Minister of India?", "options": ["Jawaharlal Nehru", "Sardar Patel", "Mahatma Gandhi", "Subhas Chandra Bose"], "correctIndex": 0, "explanation": "Jawaharlal Nehru was the first Prime Minister of India, serving from 1947 until his death in 1964." },
        //         { "id": 2, "question": "When did India gain independence?", "options": ["1942", "1947", "1950", "1962"], "correctIndex": 1, "explanation": "India gained independence from British rule on August 15, 1947." },
        //         { "id": 3, "question": "Who is known as the 'Iron Man of India'?", "options": ["Sardar Patel", "Mahatma Gandhi", "Jawaharlal Nehru", "Subhas Chandra Bose"], "correctIndex": 0, "explanation": "Sardar Vallabhbhai Patel is known as the 'Iron Man of India' for his role in integrating princely states into the Indian Union." }
        //     ],
        //     "Science": [
        //         { "id": 1, "question": "What is the chemical symbol for water?", "options": ["O2", "H2O", "CO2", "NaCl"], "correctIndex": 1, "explanation": "H2O is the chemical formula for water, meaning each molecule of water contains two hydrogen atoms and one oxygen atom." },
        //         { "id": 2, "question": "What is the powerhouse of the cell?", "options": ["Nucleus", "Mitochondria", "Ribosome", "Endoplasmic Reticulum"], "correctIndex": 1, "explanation": "Mitochondria are often called the 'powerhouses' of the cell because they generate most of the cell's supply of adenosine triphosphate (ATP), used as a source of chemical energy." },
        //         { "id": 3, "question": "What is the speed of light in a vacuum?", "options": ["300,000 km/s", "150,000 km/s", "450,000 km/s", "600,000 km/s"], "correctIndex": 0, "explanation": "The speed of light in a vacuum is approximately 299,792.458 kilometers per second, often rounded to 300,000 km/s." }
        //     ],
        //     "Math": [
        //         { "id": 1, "question": "What is 5 + 7?", "options": ["10", "11", "12", "13"], "correctIndex": 2, "explanation": "5 + 7 equals 12." },
        //         { "id": 2, "question": "What is 9 * 3?", "options": ["24", "27", "30", "33"], "correctIndex": 1, "explanation": "9 multiplied by 3 equals 27." }
        //     ],
        //     "General Knowledge": [
        //         { "id": 1, "question": "What is the capital of France?", "options": ["Berlin", "Madrid", "Paris", "Rome"], "correctIndex": 2, "explanation": "Paris is the capital and most populous city of France." },
        //         { "id": 2, "question": "Which planet is known as the Red Planet?", "options": ["Earth", "Mars", "Jupiter", "Venus"], "correctIndex": 1, "explanation": "Mars is often referred to as the Red Planet due to its reddish appearance caused by iron oxide on its surface." },
        //         { "id": 3, "question": "Who painted the Mona Lisa?", "options": ["Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Claude Monet"], "correctIndex": 2, "explanation": "The Mona Lisa is a half-length portrait painting by Italian artist Leonardo da Vinci." },
        //         { "id": 4, "question": "Who painted the Mona Lisa?", "options": ["Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Claude Monet"], "correctIndex": 2, "explanation": "The Mona Lisa is a half-length portrait painting by Italian artist Leonardo da Vinci." },
        //         { "id": 5, "question": "Who painted the Mona Lisa?", "options": ["Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Claude Monet"], "correctIndex": 2, "explanation": "The Mona Lisa is a half-length portrait painting by Italian artist Leonardo da Vinci." },
        //         { "id": 6, "question": "Who painted the Mona Lisa?", "options": ["Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Claude Monet"], "correctIndex": 2, "explanation": "The Mona Lisa is a half-length portrait painting by Italian artist Leonardo da Vinci." },
        //         { "id": 7, "question": "Who painted the Mona Lisa?", "options": ["Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Claude Monet"], "correctIndex": 2, "explanation": "The Mona Lisa is a half-length portrait painting by Italian artist Leonardo da Vinci." },
        //         { "id": 8, "question": "Who painted the Mona Lisa?", "options": ["Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Claude Monet"], "correctIndex": 2, "explanation": "The Mona Lisa is a half-length portrait painting by Italian artist Leonardo da Vinci." },
        //         { "id": 9, "question": "Who painted the Mona Lisa?", "options": ["Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Claude Monet"], "correctIndex": 2, "explanation": "The Mona Lisa is a half-length portrait painting by Italian artist Leonardo da Vinci." },
        //         { "id": 10, "question": "Who painted the Mona Lisa?", "options": ["Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Claude Monet"], "correctIndex": 2, "explanation": "The Mona Lisa is a half-length portrait painting by Italian artist Leonardo da Vinci." },
        //         { "id": 11, "question": "Who painted the Mona Lisa?", "options": ["Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Claude Monet"], "correctIndex": 2, "explanation": "The Mona Lisa is a half-length portrait painting by Italian artist Leonardo da Vinci." },
        //     ]
        // };

        document.addEventListener('DOMContentLoaded', function () {
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap JS is not loaded. The app requires Bootstrap JavaScript (bootstrap.bundle.min.js) for modals and other components.');
                // still proceed, but modal.show() calls will be guarded
            }

            // Initialize subject selection and hide test buttons
            renderSubjectTiles();
            document.getElementById('testButtons').style.display = 'none';
            document.getElementById('subjectSelectionArea').style.display = 'block';
            document.getElementById('quizContainer').style.display = 'none';

            // ---------------------- QUIZ DATA (JSON) ----------------------


            function renderSubjectTiles() {
                const subjectSelectionArea = document.getElementById('subjectSelectionArea');
                subjectSelectionArea.innerHTML = ''; // Clear existing content
                for (const subject in quizDataOriginal) {
                    const tile = document.createElement('div');
                    tile.className = 'subject-tile';

                    const subjectName = document.createElement('div');
                    subjectName.className = 'subject-name';
                    subjectName.textContent = subject;
                    tile.appendChild(subjectName);

                    const questionCount = document.createElement('div');
                    questionCount.className = 'question-count';
                    questionCount.textContent = `${quizDataOriginal[subject].length} que`;
                    tile.appendChild(questionCount);

                    if (subject === 'History') { // Assuming 'History' is a new subject for now
                        const newTag = document.createElement('span');
                        newTag.className = 'new-tag';
                        newTag.textContent = 'New';
                        tile.appendChild(newTag);
                    }

                    tile.addEventListener('click', () => {
                        selectSubject(subject);
                    });
                    subjectSelectionArea.appendChild(tile);
                }
            }

            function selectSubject(subject) {
                currentSubject = subject; // Set the current subject
                // Set quizData based on selected subject
                quizData = JSON.parse(JSON.stringify(quizDataOriginal[subject]));
                shuffle(quizData); // Shuffle questions for the selected subject

                answers.length = 0; // Clear existing answers
                answers.push(...Array(quizData.length).fill(null));
                flagged.length = 0; // Clear existing flags
                flagged.push(...Array(quizData.length).fill(false));
                skipped.clear(); // Clear existing skipped questions
                durationSec = 0;
                timerInterval = null;
                enableTimer = true;
                timerType = 'whole';
                enableSkip = false;
                // Calculate max allowed skips (30% of total questions, minimum 3)
                const maxAllowedSkips = Math.max(3, Math.floor(quizData.length * 0.3));

                const skipCountInput = document.getElementById('skipCount');
                skipCountInput.min = 1;
                skipCountInput.max = maxAllowedSkips;
                skipCountInput.value = Math.min(maxAllowedSkips, 1); // Ensure initial value is not less than 1
                skipLimit = parseInt(skipCountInput.value);

                // Update numQuestionsInput min, max, and value based on selected subject
                const numQuestionsInput = document.getElementById('numQuestions');
                const maxQuestions = quizData.length;
                numQuestionsInput.min = 1;
                numQuestionsInput.max = maxQuestions;
                numQuestionsInput.value = Math.min(10, maxQuestions);
                numQuestions = quizData.length;

                // Logic to disable skip options if total questions are less than 10
                const enableSkipCheckbox = document.getElementById('enableSkip');
                const skipSettingsDiv = document.getElementById('skipSettings');
                // const skipCountInput = document.getElementById('skipCount'); // Redeclaration removed
                const decreaseSkipCountBtn = document.getElementById('decreaseSkipCount');
                const increaseSkipCountBtn = document.getElementById('increaseSkipCount');

                if (quizData.length < 10) {
                    enableSkipCheckbox.checked = false;
                    enableSkipCheckbox.disabled = true;
                    skipCountInput.disabled = true;
                    decreaseSkipCountBtn.disabled = true;
                    increaseSkipCountBtn.disabled = true;
                    enableSkip = false; // Ensure enableSkip variable is also false
                    skipLimit = 0; // No skips allowed
                } else {
                    enableSkipCheckbox.disabled = false;
                    skipCountInput.disabled = false;
                    decreaseSkipCountBtn.disabled = false;
                    increaseSkipCountBtn.disabled = false;
                    enableSkip = enableSkipCheckbox.checked; // Restore based on checkbox state
                    // Recalculate skipLimit based on current skipCountInput value
                    skipLimit = parseInt(skipCountInput.value);
                }

                document.getElementById('subjectSelectionArea').style.display = 'none';
                document.getElementById('testButtons').style.display = 'block';
                document.getElementById('quizContainer').style.display = 'block'; // Show quiz container
                document.getElementById('quizTitle').textContent = `${subject} Quiz`; // Update quiz title
                loadQuestion();
            }

            function loadQuestion() {
                // Placeholder for loadQuestion function
                console.log('loadQuestion function called');
            }

            // ---------------------- STATE ----------------------
            let quizData = []; // working copy of quiz questions
            let currentSubject = ''; // Store the currently selected subject
            let answers = [];
            let flagged = [];
            let skipped = new Set();
            let current = 0;

            // Get subject from URL query parameter
            const urlParams = new URLSearchParams(window.location.search);
            const subject = urlParams.get('subject');

            if (subject && quizDataOriginal[subject]) {
                quizData = JSON.parse(JSON.stringify(quizDataOriginal[subject]));
                selectSubject(subject); // Automatically select the subject if valid
            } else {
                renderSubjectTiles();
                document.getElementById('quizContainer').style.display = 'none';
            }
            let durationSec = 0;
            let timerInterval = null;
            let enableTimer = true;
            let timerType = 'whole'; // 'whole' or 'perQuestion'
            let enableSkip = false; // New state variable for skip functionality
            let skipLimit = 0; // 0 for unlimited skips
            // let currentSkips = 0; // Removed this line
            let numQuestions = 0; // New state variable for number of questions

            // Utility: shuffle array (Fisher-Yates)
            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            function prepareQuestionData(dataToPrepare) {
                // shuffle options for each question but keep track of correctIndex mapping
                dataToPrepare.forEach(q => {
                    const opt = q.options.map((o, i) => ({ o, orig: i }));
                    shuffle(opt);
                    q.options = opt.map(x => x.o);
                    // find new index of original correct
                    const newIndex = opt.findIndex(x => x.orig === q.correctIndex);
                    q.correctIndex = newIndex;
                });
                return dataToPrepare;
            }

            // helper to safely show bootstrap modal (fallback to simple class toggle if bootstrap missing)
            function safeShowModal(modalInstance, modalId) {
                if (modalInstance && typeof modalInstance.show === 'function') {
                    modalInstance.show();
                } else {
                    const el = document.getElementById(modalId);
                    if (el) { el.classList.add('show', 'd-block'); el.style.backgroundColor = 'rgba(0,0,0,0.4)'; }
                }
            }
            function safeHideModal(modalInstance, modalId) {
                if (modalInstance && typeof modalInstance.hide === 'function') {
                    modalInstance.hide();
                } else {
                    const el = document.getElementById(modalId);
                    if (el) { el.classList.remove('show', 'd-block'); el.style.backgroundColor = ''; }
                }
            }

            // render question
            function render() {
                const q = quizData[current];
                const container = document.getElementById('questionArea');
                container.innerHTML = `\n      <div class=\"d-flex justify-content-between\"> \n        <div><strong>Q${current + 1}.</strong> ${q.question}</div>\n        <div><span class=\"badge bg-${flagged[current] ? 'warning' : (skipped.has(current) ? 'info' : 'secondary')}\">${flagged[current] ? 'Flagged' : (skipped.has(current) ? 'Skipped' : 'Not flagged')}</span></div>\n      </div>\n      <div class=\"mt-3\">${q.options.map((opt, idx) => `\n        <label class=\"option-label border p-2 mb-2 ${answers[current] === idx ? 'border-primary' : ''}\">\n          <input type=\"radio\" name=\"opt\" value=\"${idx}\" ${answers[current] === idx ? 'checked' : ''} style=\"margin-right:8px\"> ${opt}\n        </label>\n      `).join('')}</div>\n      ${skipped.has(current) ? '<div class=\"small text-muted mt-2\">Select option to remove from skip</div>' : ''}\n\n    `;

                document.getElementById('qIndex').innerText = `Question ${current + 1} of ${quizData.length}`;
                updateCounts();

                // wire option clicks
                document.querySelectorAll('input[name="opt"]').forEach(inp => {
                    inp.addEventListener('change', (e) => {
                        if (quizSubmitted) return; // Prevent interaction after submission
                        answers[current] = parseInt(e.target.value);
                        // if previously skipped remove skip mark
                        if (skipped.has(current)) skipped.delete(current);
                        updateCounts();
                        updateSubmissionStatus(); // Call this after an answer is selected
                        // Automatically move to the next question if not the last one
                        if (timerType !== 'perQuestion') { // Only move to next question if not 'perQuestion' timer type
                            if (current < quizData.length - 1) {
                                current++;
                            }
                        }
                        render(); // Always re-render after an answer is selected to update UI
                    });
                });

                // style flagged
                const card = container.closest('.card');
                if (flagged[current]) card.classList.add('flagged'); else card.classList.remove('flagged');

                // enable/disable prev/next and skip
                if (quizSubmitted) {
                    document.getElementById('prevBtn').disabled = true;
                    document.getElementById('nextBtn').disabled = true;
                    document.getElementById('skipBtn').disabled = true;
                    document.getElementById('flagBtn').style.display = 'none'; // Hide flag button if quiz is submitted
                    return; // Do not re-enable buttons if quiz is submitted
                }

                if (timerType === 'perQuestion') {
                    document.getElementById('prevBtn').style.display = 'none';
                    document.getElementById('nextBtn').style.display = ''; // Show next button
                    document.getElementById('skipBtn').style.display = 'none';
                    document.getElementById('flagBtn').style.display = 'none'; // Hide flag button for perQuestion type
                    document.getElementById('nextBtn').disabled = current === quizData.length - 1; // Disable next button if it's the last question
                } else {
                    document.getElementById('prevBtn').style.display = '';
                    document.getElementById('nextBtn').style.display = '';
                    document.getElementById('prevBtn').disabled = current === 0;
                    document.getElementById('nextBtn').disabled = current === quizData.length - 1;
                    const skipBtn = document.getElementById('skipBtn');
                    if (!enableSkip) {
                        skipBtn.style.display = 'none';
                    } else {
                        skipBtn.style.display = '';
                        // Disable skip button if skip limit is reached or current question is already skipped
                        skipBtn.disabled = (skipLimit > 0 && skipped.size >= skipLimit) || skipped.has(current);
                    }
                }
                updateSubmissionStatus(); // Call this after rendering the question
            }

            function updateCounts() {
                const answeredCount = answers.filter(a => a !== null).length;
                const flaggedCount = flagged.filter(Boolean).length;
                const skippedCount = skipped.size;
                document.getElementById('answeredCount').innerText = answeredCount;
                document.getElementById('flaggedCount').innerText = flaggedCount;
                document.getElementById('skippedCount').innerText = skippedCount;
            }

            // navigation
            document.getElementById('prevBtn').addEventListener('click', () => { current = Math.max(0, current - 1); render(); });
            document.getElementById('nextBtn').addEventListener('click', () => { current = Math.min(quizData.length - 1, current + 1); if (timerType === 'perQuestion') { stopTimer(); startTimer(); } render(); });

            // skip
            document.getElementById('skipBtn').addEventListener('click', () => {
                // Only allow skipping if the question is not already skipped and within skip limit
                if (!skipped.has(current) && (skipLimit === 0 || skipped.size < skipLimit)) {
                    skipped.add(current);
                    answers[current] = null; // Set answer to null when skipped
                    render(); // Re-render the current question to update UI
                    // currentSkips++; // Removed this line
                    // move next if possible
                    if (current < quizData.length - 1) current++;
                    render();
                } else if (skipped.has(current)) {
                    // If already skipped, do nothing or provide feedback that it's already skipped
                    // alert('This question is already skipped.');
                } else {
                    render();
                }
            });

            // flag
            document.getElementById('flagBtn').addEventListener('click', () => {
                flagged[current] = !flagged[current];
                render();
            });

            // refresh button
            document.getElementById('refreshBtn').addEventListener('click', () => {
                refreshConfirmModal.show();
            });

            // confirm refresh button
            document.getElementById('confirmRefreshBtn').addEventListener('click', () => {
                location.reload();
            });
            let reviewModal = null;
            let scoreModal = null;
            let retakeConfirmModal = null;
            let customSettingsModal = null; // Initialize custom settings modal
            let refreshConfirmModal = null; // New modal for refresh confirmation

            try {
                reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));
                scoreModal = new bootstrap.Modal(document.getElementById('scoreModal'));
                retakeConfirmModal = new bootstrap.Modal(document.getElementById('retakeConfirmModal'));
                customSettingsModal = new bootstrap.Modal(document.getElementById('customSettingsModal')); // New modal
                refreshConfirmModal = new bootstrap.Modal(document.getElementById('refreshConfirmModal')); // New modal
            } catch (err) { console.warn('Unable to initialize bootstrap modals:', err); }

            function populateReviewLists() {
                const skippedList = document.getElementById('skippedList'); skippedList.innerHTML = '';
                const unansweredList = document.getElementById('unansweredList'); unansweredList.innerHTML = '';
                const flaggedList = document.getElementById('flaggedList'); flaggedList.innerHTML = '';
                const answeredList = document.getElementById('answeredList'); answeredList.innerHTML = '';

                let hasFlagged = false;
                let hasSkipped = false;
                let hasUnanswered = false;
                let hasAnswered = false;

                for (let i = 0; i < quizData.length; i++) {
                    const q = quizData[i];
                    const li = document.createElement('li');
                    li.classList.add('list-group-item', 'list-group-item-action');
                    li.dataset.questionIndex = i;
                    const questionText = q.question.length > 50 ? q.question.slice(0, 50) + '...' : q.question;
                    li.innerText = `Q${i + 1}: ${questionText}`;
                    li.addEventListener('click', (event) => {
                        // Prevent redirection if the click originated from a radio button or its label
                        if (event.target.tagName === 'INPUT' && event.target.type === 'radio' || event.target.tagName === 'LABEL') {
                            return;
                        }
                        safeHideModal(reviewModal, 'reviewModal'); current = i; render();
                    });

                    if (flagged[i]) {
                        flaggedList.appendChild(li);
                        hasFlagged = true;
                    } else if (skipped.has(i)) {
                        skippedList.appendChild(li);
                        hasSkipped = true;
                    } else if (answers[i] === null) {
                        unansweredList.appendChild(li);
                        hasUnanswered = true;
                    } else {
                        const selectedOptionIndex = answers[i];
                        const optionsHtml = q.options.map((option, optIndex) => {
                            const isChecked = (optIndex === selectedOptionIndex) ? 'checked' : '';
                            return `
            <div class="form-check">
              <input class="form-check-input" type="radio" name="reviewQuestion${i}" id="reviewQuestion${i}Option${optIndex}" value="${optIndex}" ${isChecked} onclick="event.stopPropagation();">
              <label class="form-check-label" for="reviewQuestion${i}Option${optIndex}" onclick="event.stopPropagation();">
                ${option}
              </label>
            </div>
          `;
                        }).join('');

                        li.innerHTML = `
          <div>Q${i + 1}: ${questionText}</div>
          <div class="options-container mt-2">${optionsHtml}</div>
        `;
                        answeredList.appendChild(li);
                        hasAnswered = true;

                        // Add event listeners to the radio buttons for changing answers
                        li.querySelectorAll('input[type="radio"]').forEach(radio => {
                            radio.addEventListener('change', (event) => {
                                event.stopPropagation(); // Prevent the click event from bubbling up to the li element
                                answers[i] = parseInt(event.target.value);
                                updateSubmissionStatus();

                                // Manually update the checked state of radio buttons for the current question
                                const questionContainer = event.target.closest('.options-container'); // Find the container for options
                                if (questionContainer) {
                                    questionContainer.querySelectorAll(`input[name="reviewQuestion${i}"]`).forEach(radioBtn => {
                                        radioBtn.checked = (radioBtn === event.target); // Check only the clicked radio button
                                    });
                                }
                            });
                        });
                    }
                }

                // Hide sections if their lists are empty
                document.getElementById('flaggedList').closest('.col-md-6').style.display = hasFlagged ? 'block' : 'none';
                document.getElementById('skippedList').closest('.col-md-6').style.display = hasSkipped ? 'block' : 'none';
                document.getElementById('unansweredList').closest('.col-md-6').style.display = hasUnanswered ? 'block' : 'none';
                document.getElementById('answeredQuestionsSection').style.display = hasUnanswered ? 'none' : 'block'; // Show answered section only if no unanswered questions

                if (hasSkipped) {
                    const skippedListElement = document.getElementById('skippedList');
                    // Clear previous messages to avoid duplication
                    const existingMessage = skippedListElement.previousElementSibling;
                    if (existingMessage && existingMessage.classList.contains('skip-message')) {
                        existingMessage.remove();
                    }
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('small', 'text-muted', 'mb-2', 'skip-message');
                    messageDiv.innerText = 'Select option to remove from skip';
                    skippedListElement.insertAdjacentElement('beforebegin', messageDiv);
                }

                updateSubmissionStatus(); // Call this after populating review lists
            }

            function updateSubmissionStatus() {
                let allNonSkippedAnswered = true;
                for (let i = 0; i < quizData.length; i++) {
                    if (!skipped.has(i) && answers[i] === null) {
                        allNonSkippedAnswered = false;
                        break;
                    }
                }

                const confirmSubmitBtn = document.getElementById('confirmSubmit');
                const submissionWarning = document.getElementById('submissionWarning');
                const declarationCheckbox = document.getElementById('declarationCheckbox');

                if (allNonSkippedAnswered && declarationCheckbox.checked) {
                    confirmSubmitBtn.disabled = false;
                    submissionWarning.style.display = 'none';
                } else {
                    confirmSubmitBtn.disabled = true;
                    submissionWarning.style.display = 'block';
                }
            }

            document.getElementById('declarationCheckbox').addEventListener('change', updateSubmissionStatus);
            document.getElementById('confirmSubmit').addEventListener('click', () => {
                if (!document.getElementById('confirmSubmit').disabled) {
                    safeHideModal(reviewModal, 'reviewModal'); stopTimer(); showScore();
                }
            });

            document.getElementById('reviewBtn').addEventListener('click', () => {
                if (timerType === 'perQuestion') {
                    stopTimer();
                    showScore();
                } else {
                    populateReviewLists();
                    safeShowModal(reviewModal, 'reviewModal');
                    updateSubmissionStatus(); // Call this when review modal is shown
                }
            });

            // timer
            function startTimer() {
                if (!enableTimer) {
                    document.getElementById('timer').innerText = '--:--';
                    return;
                }

                stopTimer(); // Clear any existing timer

                let remaining;
                if (timerType === 'perQuestion') {
                    remaining = parseInt(document.getElementById('timerDuration').value); // Duration is in seconds for perQuestion
                } else {
                    remaining = durationSec; // For whole test, use the global durationSec
                }

                updateTimerDisplay(remaining);
                timerInterval = setInterval(() => {
                    remaining--;
                    if (remaining <= 0) {
                        clearInterval(timerInterval);
                        if (timerType === 'perQuestion') {
                            // Handle per-question timer expiry
                            // Disable current question options
                            const currentQuestionOptions = document.querySelectorAll(`#question${current} input[type="radio"]`);
                            currentQuestionOptions.forEach(option => option.disabled = true);

                            // Mark question as skipped/unanswered if not already answered
                            if (answers[current] === null) {
                                skipped.add(current);
                                updateSubmissionStatus();
                            }

                            // Move to next question
                            nextQuestion();
                            // Start timer for the new question if it's still perQuestion type
                            // This check is important because nextQuestion() might lead to showScore()
                            // or change the timerType if the quiz ends.
                            // The logic to start the timer for the new question is now inside nextQuestion()
                            // if (timerType === 'perQuestion' && current < quizData.length) {
                            //   startTimer();
                            // }
                        } else {
                            // Handle whole test timer expiry
                            alert('Time up! Submitting automatically.');
                            showScore();
                        }
                    }
                    updateTimerDisplay(remaining);
                }, 1000);
            }
            function stopTimer() { if (timerInterval) clearInterval(timerInterval); }

            function nextQuestion() {
                if (current < quizData.length - 1) {
                    current++;
                    render();
                    if (timerType === 'perQuestion') {
                        stopTimer();
                        startTimer();
                    }
                } else {
                    // If it's the last question, show score or handle end of quiz
                    showScore();
                }
            }

            function updateTimerDisplay(sec) {
                if (!enableTimer) return;
                const m = Math.floor(sec / 60).toString().padStart(2, '0');
                const s = (sec % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }

            function disableQuizInteraction() {
                document.getElementById('prevBtn').disabled = true;
                document.getElementById('nextBtn').disabled = true;
                document.getElementById('skipBtn').disabled = true;
                document.getElementById('flagBtn').disabled = true;
                document.getElementById('reviewBtn').disabled = true;

                // Disable all radio buttons across all questions
                const allRadioButtons = document.querySelectorAll('#quizContainer input[type="radio"]');
                allRadioButtons.forEach(radio => {
                    radio.disabled = true;
                });
            }

            function enableQuizInteraction() {
                document.getElementById('prevBtn').disabled = false;
                document.getElementById('nextBtn').disabled = false;
                document.getElementById('skipBtn').disabled = false;
                document.getElementById('flagBtn').disabled = false;
                document.getElementById('reviewBtn').disabled = false;
                const optionsDiv = document.getElementById('options');
                if (optionsDiv) {
                    const radioButtons = optionsDiv.querySelectorAll('input[type="radio"]');
                    radioButtons.forEach(radio => {
                        radio.disabled = false;
                    });
                }
            }

            // scoring & report
            let quizSubmitted = false; // New global variable to track quiz submission status

            // scoring & report
            function showScore() {
                quizSubmitted = true; // Set to true when quiz is submitted
                disableQuizInteraction();
                // compute
                let correct = 0;
                let skippedCount = 0;
                const details = quizData.map((q, i) => {
                    const user = answers[i];
                    const isSkipped = skipped.has(i);
                    if (isSkipped) skippedCount++;
                    const isCorrect = user === q.correctIndex;
                    if (isCorrect) correct++;
                    return { i, question: q.question, options: q.options, user, correctIndex: q.correctIndex, isCorrect, explanation: q.explanation, isSkipped };
                });

                const scoreSummary = document.getElementById('scoreSummary');
                scoreSummary.innerHTML = `<h4>Your score: ${correct} / ${quizData.length}</h4><div class='small text-muted'>Answered: ${answers.filter(a => a !== null).length - skippedCount}</div><div class='small text-muted'>Skipped: ${skippedCount}</div>`;
                if (enableTimer) {
                    scoreSummary.innerHTML += `<div class='small text-muted'>Time taken: ${formatTime(durationSec - (parseInt(document.getElementById('timer').innerText.split(':')[0]) * 60 + parseInt(document.getElementById('timer').innerText.split(':')[1])))}</div>`;
                } else {
                    scoreSummary.innerHTML += `<div class='small text-muted'>Timer: Disabled</div>`;
                }


                const detailed = document.getElementById('detailedReport'); detailed.innerHTML = '';
                details.forEach(d => {
                    const wrap = document.createElement('div'); wrap.className = 'mb-3 p-2 border rounded';
                    const qh = document.createElement('div'); qh.innerHTML = `<strong>Q${d.i + 1}.</strong> ${d.question} ${d.isSkipped ? '<span class="badge bg-info">Skipped</span>' : ''}`;
                    wrap.appendChild(qh);
                    const ul = document.createElement('div');
                    d.options.forEach((opt, j) => {
                        const p = document.createElement('div');
                        p.innerText = opt;
                        if (j === d.correctIndex) p.className = 'correct';
                        if (d.user === j && !d.isCorrect) p.className = 'wrong';
                        if (d.user === j && d.isCorrect) p.className = 'correct';
                        ul.appendChild(p);
                    });
                    const ex = document.createElement('div'); ex.className = 'mt-2 explain'; ex.innerHTML = `<strong>Explanation:</strong> ${d.explanation}`;
                    wrap.appendChild(ul); wrap.appendChild(ex);
                    detailed.appendChild(wrap);
                });

                safeShowModal(scoreModal, 'scoreModal');
                // enableQuizInteraction(); // Enable quiz interaction when retaking
            }

            function formatTime(seconds) {
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                return `${m}:${s}`;
            }

            // Global variable to store initial quiz settings for retake functionality
            let initialQuizSettings = {};

            function retake(subject, enableTimerSetting, durationSetting, skipLimitSetting, timerTypeSetting, enableSkipSetting, numQuestionsSetting) {
                quizSubmitted = false; // Reset quiz submission status
                enableQuizInteraction(); // Enable quiz interaction when retaking
                enableTimer = enableTimerSetting;
                durationSec = durationSetting;
                skipLimit = skipLimitSetting;
                timerType = timerTypeSetting;
                enableSkip = enableSkipSetting;
                numQuestions = numQuestionsSetting;

                // restore fresh data from original quizData then shuffle questions and options
                quizData = JSON.parse(JSON.stringify(quizDataOriginal[subject]));
                shuffle(quizData);
                quizData = quizData.slice(0, numQuestions); // Limit the number of questions
                quizData = prepareQuestionData(quizData);

                // reset answers/flags/skips AFTER quizData is finalized
                answers = Array(quizData.length).fill(null);
                flagged = Array(quizData.length).fill(false);
                skipped = new Set();
                currentSkips = 0;

                current = 0;
                render();
                stopTimer(); // Stop any existing timer
                startTimer();
            }

            // New function to start the quiz
            function startQuiz(enableTimerSetting, durationSetting, skipLimitSetting, timerTypeSetting, enableSkipSetting, numQuestionsSetting) {
                // Store initial settings
                initialQuizSettings = {
                    enableTimer: enableTimerSetting,
                    duration: durationSetting,
                    skipLimit: skipLimitSetting,
                    timerType: timerTypeSetting,
                    enableSkip: enableSkipSetting,
                    numQuestions: numQuestionsSetting
                };

                document.getElementById('quickTestBtn').style.display = 'none';
                document.getElementById('customTestBtn').style.display = 'none';
                document.getElementById('quizHeaderContainer').classList.remove('d-none');
                document.getElementById('quizHeaderContainer').classList.add('d-flex'); // Show quiz header container with flex display

                document.getElementById('retakeFromScore').style.display = 'block'; // Show retake button
                document.getElementById('questionArea').closest('.card').style.display = 'block'; // Show quiz area
                document.getElementById('statusBar').style.display = 'block'; // Show status bar

                retake(currentSubject, enableTimerSetting, durationSetting, skipLimitSetting, timerTypeSetting, enableSkipSetting, numQuestionsSetting);
            }

            // Event Listeners for new buttons
            document.getElementById('quickTestBtn').addEventListener('click', () => {
                // Default settings for quick test: timer enabled (10 min), unlimited skips, whole test timer, skip disabled, 10 questions
                startQuiz(true, 10 * 60, 0, 'whole', false, 10);
            });

            document.getElementById('customTestBtn').addEventListener('click', () => {
                // Set max questions for custom test
                console.log("quizDataOriginal[currentSubject].length", quizDataOriginal[currentSubject].length); // Debugging line
                document.getElementById('numQuestions').max = quizDataOriginal[currentSubject].length;
                safeShowModal(customSettingsModal, 'customSettingsModal');
            });

            document.getElementById('startCustomTestBtn').addEventListener('click', () => {
                const enableTimerSetting = document.getElementById('enableTimer').checked;
                let durationSetting = parseInt(document.getElementById('timerDuration').value);
                if (isNaN(durationSetting)) { // Ensure durationSetting is a valid number
                    durationSetting = 0; // Default to 0 or a sensible default if NaN
                }
                durationSetting *= 60; // Convert minutes to seconds
                const enableSkipSetting = document.getElementById('enableSkip').checked;
                let skipLimitSetting = enableSkipSetting ? parseInt(document.getElementById('skipCount').value) : 0;
                const timerTypeSetting = document.querySelector('input[name="timerType"]:checked').value;
                const numQuestionsSetting = parseInt(document.getElementById('numQuestions').value);

                // Calculate max allowed skips based on numQuestionsSetting
                const maxAllowedSkips = Math.max(1, Math.floor(numQuestionsSetting * 0.3));

                // Ensure skipLimitSetting does not exceed maxAllowedSkips
                if (skipLimitSetting > maxAllowedSkips) {
                    skipLimitSetting = maxAllowedSkips;
                }

                safeHideModal(customSettingsModal, 'customSettingsModal');
                startQuiz(enableTimerSetting, durationSetting, skipLimitSetting, timerTypeSetting, enableSkipSetting, numQuestionsSetting);
            });

            // Update skipCount max attribute when numQuestions changes
            document.getElementById('numQuestions').addEventListener('input', (e) => {
                const numQuestions = parseInt(e.target.value);
                const skipCountInput = document.getElementById('skipCount');
                const maxAllowedSkips = Math.max(1, Math.floor(numQuestions * 0.3));
                skipCountInput.max = maxAllowedSkips;
                if (parseInt(skipCountInput.value) > maxAllowedSkips) {
                    skipCountInput.value = maxAllowedSkips;
                }
            });

            // Toggle timer settings visibility
            document.getElementById('enableTimer').addEventListener('change', (e) => {
                document.getElementById('timerSettings').style.display = e.target.checked ? 'block' : 'none';
            });

            // Toggle skip settings visibility
            document.getElementById('enableSkip').addEventListener('change', (e) => {
                document.getElementById('skipSettings').style.display = e.target.checked ? 'block' : 'none';
            });

            // Retake from score modal
            document.getElementById('retakeFromScore').addEventListener('click', () => { // This is the retake button from the main quiz area
                safeShowModal(retakeConfirmModal, 'retakeConfirmModal');
            });

            document.getElementById('confirmRetakeBtn').addEventListener('click', () => {
                safeHideModal(retakeConfirmModal, 'retakeConfirmModal');
                // Use stored initial settings for retake
                retake(currentSubject, initialQuizSettings.enableTimer, initialQuizSettings.duration, initialQuizSettings.skipLimit, initialQuizSettings.timerType, initialQuizSettings.enableSkip, initialQuizSettings.numQuestions);
            });

            document.getElementById('retakeFromScoreModal').addEventListener('click', () => {
                safeHideModal(scoreModal, 'scoreModal');
                safeShowModal(retakeConfirmModal, 'retakeConfirmModal');
            });

            document.getElementById('closeScore').addEventListener('click', () => { /* no-op */ });

            // Initial state: hide quiz area and status bar, show start buttons
            document.getElementById('questionArea').closest('.card').style.display = 'none';
            document.getElementById('statusBar').style.display = 'none';
            document.getElementById('retakeFromScore').style.display = 'none'; // Hide retake button initially


            const timerDurationInput = document.getElementById('timerDuration');
            const decreaseTimerDurationBtn = document.getElementById('decreaseTimerDuration');
            const increaseTimerDurationBtn = document.getElementById('increaseTimerDuration');

            let holdingInterval;

            function startHolding(action) {
                action(); // Execute once immediately
                holdingInterval = setInterval(action, 100); // Repeat every 100ms
            }

            function stopHolding() {
                clearInterval(holdingInterval);
            }

            decreaseTimerDurationBtn.addEventListener('mousedown', function () {
                startHolding(function () {
                    let currentValue = parseInt(timerDurationInput.value);
                    if (currentValue > parseInt(timerDurationInput.min)) {
                        timerDurationInput.value = currentValue - 1;
                    }
                });
            });
            decreaseTimerDurationBtn.addEventListener('mouseup', stopHolding);
            decreaseTimerDurationBtn.addEventListener('mouseleave', stopHolding); // Stop if mouse leaves button while holding

            increaseTimerDurationBtn.addEventListener('mousedown', function () {
                startHolding(function () {
                    let currentValue = parseInt(timerDurationInput.value);
                    if (currentValue < parseInt(timerDurationInput.max) || isNaN(parseInt(timerDurationInput.max))) {
                        timerDurationInput.value = currentValue + 1;
                    }
                });
            });
            increaseTimerDurationBtn.addEventListener('mouseup', stopHolding);
            increaseTimerDurationBtn.addEventListener('mouseleave', stopHolding); // Stop if mouse leaves button while holding

            const numQuestionsInput = document.getElementById('numQuestions');
            const decreaseNumQuestionsBtn = document.getElementById('decreaseNumQuestions');
            const increaseNumQuestionsBtn = document.getElementById('increaseNumQuestions');
            const skipCountInput = document.getElementById('skipCount'); // Moved declaration here

            // Set initial max for skipCount based on initial numQuestions
            const initialNumQuestions = parseInt(numQuestionsInput.value);
            // const skipCountInput = document.getElementById('skipCount'); // This line was causing the redeclaration error
            const initialMaxAllowedSkips = Math.max(1, Math.floor(initialNumQuestions * 0.3));
            skipCountInput.max = initialMaxAllowedSkips;
            if (parseInt(skipCountInput.value) > initialMaxAllowedSkips) {
                skipCountInput.value = initialMaxAllowedSkips;
            }

            decreaseNumQuestionsBtn.addEventListener('mousedown', function () {
                startHolding(function () {
                    let currentValue = parseInt(numQuestionsInput.value);
                    if (currentValue > parseInt(numQuestionsInput.min)) {
                        numQuestionsInput.value = currentValue - 1;
                    }
                });
            });
            decreaseNumQuestionsBtn.addEventListener('mouseup', stopHolding);
            decreaseNumQuestionsBtn.addEventListener('mouseleave', stopHolding); // Stop if mouse leaves button while holding

            increaseNumQuestionsBtn.addEventListener('mousedown', function () {
                startHolding(function () {
                    let currentValue = parseInt(numQuestionsInput.value);
                    if (currentValue < parseInt(numQuestionsInput.max) || isNaN(parseInt(numQuestionsInput.max))) {
                        numQuestionsInput.value = currentValue + 1;
                    }
                });
            });
            increaseNumQuestionsBtn.addEventListener('mouseup', stopHolding);
            increaseNumQuestionsBtn.addEventListener('mouseleave', stopHolding); // Stop if mouse leaves button while holding

            const decreaseSkipCountBtn = document.getElementById('decreaseSkipCount');
            const increaseSkipCountBtn = document.getElementById('increaseSkipCount');
            const skipSettingsDiv = document.getElementById('skipSettings');
            const enableSkipCheckbox = document.getElementById('enableSkip');

            decreaseSkipCountBtn.addEventListener('mousedown', function () {
                startHolding(function () {
                    let currentValue = parseInt(skipCountInput.value);
                    if (currentValue > parseInt(skipCountInput.min)) {
                        skipCountInput.value = currentValue - 1;
                    }
                });
            });
            decreaseSkipCountBtn.addEventListener('mouseup', stopHolding);
            decreaseSkipCountBtn.addEventListener('mouseleave', stopHolding); // Stop if mouse leaves button while holding

            increaseSkipCountBtn.addEventListener('mousedown', function () {
                startHolding(function () {
                    let currentValue = parseInt(skipCountInput.value);
                    if (currentValue < parseInt(skipCountInput.max) || isNaN(parseInt(skipCountInput.max))) {
                        skipCountInput.value = currentValue + 1;
                    }
                });
            });
            increaseSkipCountBtn.addEventListener('mouseup', stopHolding);
            increaseSkipCountBtn.addEventListener('mouseleave', stopHolding); // Stop if mouse leaves button while holding



            enableSkipCheckbox.addEventListener('change', function () {
                if (this.checked) {
                    skipSettingsDiv.style.display = 'block';
                } else {
                    skipSettingsDiv.style.display = 'none';
                }
            });

            // Initial state for skipSettingsDiv based on enableSkipCheckbox
            if (!enableSkipCheckbox.checked) {
                skipSettingsDiv.style.display = 'none';
            }

        }); // End of DOMContentLoaded
    </script>
</body>

</html>

<div class="alert alert-danger" role="alert" id="warningMessage" style="display: none;">
    Please answer all non-skipped questions before final submit.
</div>

<div class="container mt-4">
</div>
